<link rel="import" href="../polymer/polymer.html">
<script src="../d3/d3.js"></script>

<dom-module id="plutonium-pie-chart">
    <template>
        <style>
            :host {
                display: block;
            }
        </style>
        <svg id="canvas">
        <g id="transformer"></g>
        </svg>
    </template>
    <script>
        Polymer({
            is: 'plutonium-pie-chart',
            behaviors: [
            ],
//            extends: 'svg',
            properties: {
                _radius: {
                    type: Number,
                    notify: true,
//                    computed: 'computeRadius(width, height)'
                },
                _palette: {
                    type: Object,
                    notify: true
                },
                _arc: {
                    type: Object,
                    notify: true
                },
                _labelArc: {
                    type: Object,
                    notify: true
                },
                _pie: {
                    type: Object,
                    notify: true
                },
                attrForSelected: {
                    type: String,
                    notify: true,
                    value: 'value'
                },
                attrForLabel: {
                    type: String,
                    notify: true,
                    value: 'name'
                },
                items: {
                    type: Array,
                    notify: true,
//                    observer: 'observeItems',
                    value: ["#98abc5", "#8a89a6", "#7b6888", "#6b486b", "#a05d56", "#d0743c", "#ff8c00"]
                },
                dataUrl: {
                    type: String,
                    notify: true
                },
                data: {
                    type: Object,
                    notify: true
                },
                width: {
                    type: Number,
                    value: 100,
                    reflectToAttribute: true,
                    notify: true
                },
                height: {
                    type: Number,
                    value: 100,
                    reflectToAttribute: true,
                    notify: true
                }
            },
            observers: [
                'observeSize(width, height)',
                'observeItems(items)',
                'observeDataUrl(attrForLabel, _pie, dataUrl)',
                'observeData(attrForLabel, _pie, data)',
                'observeLayout(attrForSelected)'
            ],
            observeLayout: function (attrForSelected) {
                var self = this;
                // Pie visualization.
                this._pie = d3.layout.pie()
                        .sort(null)
                        .value(function (d) {
                            return d[self.attrForSelected];
                        });
            },
            observeSize: function (width, height) {
                // Calculate radius,
                this._radius = Math.min(width, height) / 2;
                // Create arc function
                this._arc = d3.svg.arc().outerRadius(this._radius - 10).innerRadius(0);
                // reate arc function for labels
                this._labelArc = d3.svg.arc().outerRadius(this._radius - 40).innerRadius(this._radius - 40);
                // Synchronize svg size.
                d3.select(this.$.canvas).attr("width", width).attr("height", height)
                // Translate graphics into content. 
                d3.select(this.$.transformer).attr("transform", "translate(" + width / 2 + "," + height / 2 + ")");

            },
            observeItems: function (items) {
                // Create color palette for the items.
                this._palette = d3.scale.ordinal().range(items);
            },
            observeDataUrl: function (attrForLabel, _pie, dataUrl) {
                var self = this;

                d3.json(dataUrl, function (error, data) {
                    if (error)
                        throw error;
                    var g = d3.select(self.$.transformer).selectAll(".arc")
                            .data(self._pie(data))
                            .enter().append("g")
                            .attr("class", "arc");

                    g.append("path").attr("d", self._arc).style("fill", function (d) {
                        return self._palette(d.data[self.attrForLabel]);
                    });

                    g.append("text").attr("transform", function (d) {
                        return "translate(" + self._labelArc.centroid(d) + ")";
                    }).attr("dy", ".35em").text(function (d) {
                        return d.data[self.attrForLabel];
                    });
                });
            },
            observeData: function (attrForLabel, pie, data) {
                var self = this;

                var g = d3.select(self.$.transformer).selectAll(".arc")
                        .data(self._pie(data))
                        .enter().append("g")
                        .attr("class", "arc");

                g.append("path").attr("d", self._arc).style("fill", function (d) {
                    return self._palette(d.data[self.attrForLabel]);
                });

                g.append("text").attr("transform", function (d) {
                    return "translate(" + self._labelArc.centroid(d) + ")";
                }).attr("dy", ".35em").text(function (d) {
                    return d.data[self.attrForLabel];
                });

            }
        });
    </script>
</dom-module>
